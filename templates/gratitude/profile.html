{% extends 'base.html' %}
{% load i18n %}
{% load extras %}

{% block title %}{% trans 'Express Your Gratitude!' %}{% endblock %}
{% block content_title %}<h2 class="content-title">{% trans 'Express Your Gratitude!' %}</h2>{% endblock %}

{% block content %}

<div id="fb-root"></div>
<script>
      function publishGratitude(gratitudeTextId, gratitudeDateId) {
         var gratitudeDate = document.getElementById(gratitudeDateId).textContent; 
         var gratitudeText = document.getElementById(gratitudeTextId).textContent; 
         var gratitudeId = document.getElementById(gratitudeTextId).getAttribute("gratitudeId"); 
         console.log("Gratitude id: " + gratitudeId);
         var gratitudeCaption = 'My gratitude for ' + gratitudeDate;
         facebookShare(gratitudeText, gratitudeCaption, gratitudeId);
      }

      function facebookShare(gratitudeText, gratitudeCaption, gratitudeId) {
         var obj = {
            method: 'feed',
            display: 'popup',
            name: gratitudeText,
            caption: gratitudeCaption,
            description: 'From artofgratitude.com &mdash; a free site for cultivating the daily practice of gratitude.',
            link: '{{base_url}}',
            picture: '{{media_url}}/img/art_of_gratitude_leaf_large_square-128x128.png'
         };

        function callback(response) {
            $.ajax({
              url: "/app/gratitude/api/v1/action/share_gratitude_facebook/" + gratitudeId + "/?format=json", 
              context: document.body
            });
        }

        FB.ui(obj, callback);
      }

      function facebookShareSite() {
         var obj = {
            method: 'feed',
            display: 'popup',
            name: 'The Art of Gratitude',
            caption: 'A free site for cultivating the daily practice of gratitude.',
            link: '{{base_url}}',
            picture: '{{media_url}}/img/art_of_gratitude_leaf_large_square-128x128.png'
         };

        function callback(response) {
            $.ajax({
              url: "/app/gratitude/api/v1/action/share_site_facebook/?format=json",
              context: document.body
            }).done(function() {
               $("#fb-share-artofgratitude-site").alert('close');
            });
        }

        FB.ui(obj, callback);
      }
</script>

<div class="profile-preferences">
   <a href="{{site_prefix}}/accounts/{{ user.username }}">Preferences</a><br>
</div>
<div class="row">
   <div class="span9">
      <h2 class="profile-header">{{ user.first_name }} {{ user.last_name }} - Your Gratitudes</h2>
      <p/>
      <ol reversed start="{{gratitudes_length}}">
         {% if form_fields|length > 0 %}
            <p/>
            <p class="profile-text profile-item"><i>{% trans "Enter your gratitudes for today in the boxes below (remember to start with 'I'm grateful for...'):" %}</i><p/>
            <br>
            <form action="{{ site_prefix }}/profile/{{ user.username }}" method="post">
               {% for field in form_fields %}
               {{ field }}<br>
               {% endfor %}
                  <input class="btn btn-primary" type="submit" value="Save your gratitudes!"/>
            </form>
         {% else %}
            {% if not action_shared_site %}
               <div id="fb-share-artofgratitude-site" class="alert alert-success">
                  <span><input id="fb-share-artofgratitude-site-button" type="image" src="{{site_prefix}}/media/img/fb-share.png" class="profile-fb-share" alt="Post to Facebook" onclick="facebookShareSite()" />Share the Art of Gratitude website (this won't share any of your gratitudes below)</span><button type="button" class="close" data-dismiss="alert">&times;</button>{{ message }}<br>
               </div>
            {% endif %} 
         {% endif %}
         {% for group in gratitudes %}
            <div class="well">
               <div class="profile-text profile-day">
                  <i><div id="gratitude-date-{{forloop.counter}}">{{group.0.created|date:"l, F jS, Y"}}</div></i>
               </div>
               {% for gratitude in group %}
                  <div class="row-fluid">
                     <div class="profile-item">
                        <div class="span12">
                           <li class="profile-text" value="{{gratitude.listValue}}">
                              <span id="gratitude-text-{{forloop.parentloop.counter}}-{{forloop.counter}}" gratitudeId="{{gratitude.id}}">{{ gratitude.text }}</span> 
                              <span class="pull-right {% if forloop.parentloop.counter > 1 %}profile-hidden{% endif %}"><input id="gratitude-fbshare-{{forloop.parentloop.counter}}-{{forloop.counter}}" type="image" src="{{site_prefix}}/media/img/fb-share.png" class="profile-fb-share" alt="Post to Facebook" onclick="publishGratitude('gratitude-text-{{forloop.parentloop.counter}}-{{forloop.counter}}','gratitude-date-{{forloop.parentloop.counter}}')" /></span>
                           </li>
                        </div>
                     </div>
                  </div>
               {% endfor %}
            </div>
         {% endfor %}
         </ol>
      <p/>
      {% if form_fields|length <= 0 %}
         <p class="profile-text profile-item"><i>{% trans "Look for your daily gratitude email in your inbox tomorrow!" %}</i><p/>
      {% endif %}
   </div> 
   <div class="span2"><div class="daybadge">Day<br><h2>{{days_so_far}}</h2>
         {% if days_so_far <= days_of_gratitude %}
            <span class="centered">of {{days_of_gratitude}}</span>
         {% endif %}
   </div></div>
   <div class="span1"></div>
</div>
{% endblock %}
{% block content-footer %}
{% endblock %}
{% block javascript %}
   <script>
      window.fbAsyncInit = function() {
        console.log('Initializing Facebook SDK...');
        FB.init({appId: '{{facebook_app_id}}', status: true, cookie: true,
                 xfbml: true});
        console.log('Facebook init done.');
      };
      (function() {
        var e = document.createElement('script'); e.async = true;
        e.src = document.location.protocol +
          '//connect.facebook.net/en_US/all.js';
        document.getElementById('fb-root').appendChild(e);
      }());
   </script>
{% endblock %}
